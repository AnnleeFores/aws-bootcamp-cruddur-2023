{"version":3,"file":"deploy.js","mappings":"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","sources":["webpack://nextjs13-lambda/./src/build.ts","webpack://nextjs13-lambda/./src/deploy.ts","webpack://nextjs13-lambda/./src/index.ts","webpack://nextjs13-lambda/./src/utils.ts","webpack://nextjs13-lambda/external node-commonjs \"child_process\"","webpack://nextjs13-lambda/external node-commonjs \"fs\"","webpack://nextjs13-lambda/external node-commonjs \"path\"","webpack://nextjs13-lambda/webpack/bootstrap","webpack://nextjs13-lambda/webpack/before-startup","webpack://nextjs13-lambda/webpack/startup","webpack://nextjs13-lambda/webpack/after-startup"],"sourcesContent":["import path from \"path\";\nimport fs from \"fs\";\nimport { filePath } from \"./utils\";\nimport { term } from \"./utils\";\n\nconst nextjsBuild = async () => {\n  console.log(\"Running Next Build......\");\n  await term(\"npm run build\");\n};\n\nconst nextPackage = () => {\n  console.log(\"Copying static files.....\");\n  const { srcPath, publicPath, standaloneOutputPath } = filePath();\n\n  const destPublic = path.join(standaloneOutputPath, \"public\");\n\n  // Copy public files to standalone\n  if (fs.existsSync(publicPath)) {\n    if (!fs.existsSync(destPublic)) {\n      fs.mkdirSync(destPublic, { recursive: true });\n    }\n    fs.cpSync(publicPath, destPublic, { recursive: true });\n\n    // Copy favicon\n    const faviconPath = path.join(srcPath, \"favicon.ico\");\n\n    if (fs.existsSync(faviconPath)) {\n      fs.copyFileSync(faviconPath, path.join(destPublic, \"favicon.ico\"));\n    }\n  }\n};\n\nconst CreateRunScript = () => {\n  console.log(\"Creating run script.....\");\n\n  const { standaloneOutputPath } = filePath();\n\n  // run bash script code\n  const script = `#!/bin/bash\n[ ! -d '/tmp/cache' ] && mkdir -p /tmp/cache\nexec node server.js`;\n\n  fs.writeFile(`${standaloneOutputPath}/run.sh`, script, (err) => {\n    if (err) throw err;\n  });\n};\n\nexport const build = async () => {\n  await nextjsBuild();\n  nextPackage();\n  CreateRunScript();\n  console.log(\"Build complete!\");\n};\n","import { filePath, term } from \"./utils\";\n\nconst { tfPath, appPath } = filePath();\n\nexport const tfDeploy = async () => {\n  console.log(\"Running deploy command.....\");\n  await term(\n    `terraform -chdir=${tfPath}/ apply -var=\"SOURCE_DIR=${appPath}/.next\" --auto-approve`\n  );\n  console.log(\"\\nDeploy complete!\");\n  console.log(\n    \"\\nWait for CloudFront Deployment/Invalidation to complete....\\n\"\n  );\n};\n\nexport const tfDelete = async () => {\n  const { tfPath } = filePath();\n  console.log(\"Running deployment delete command.....\");\n  await term(\n    `terraform -chdir=${tfPath}/ destroy -var=\"SOURCE_DIR=${appPath}/.next\" --auto-approve`\n  );\n  console.log(\"Delete complete!\");\n};\n","import { build } from \"./build\";\nimport { tfDelete, tfDeploy } from \"./deploy\";\n\nconst deploy = async () => {\n  await build();\n  await tfDeploy();\n};\n\nconst del = async () => {\n  await tfDelete();\n};\n\n//Todo: Configure Deploy, Build, Delete conditionals\n\nconst run = () => {\n  const args = process.argv.slice(2);\n  if (args[0] === \"deploy\") {\n    deploy();\n  } else if (args[0] === \"build\") {\n    build();\n  } else if (args[0] === \"delete\") {\n    del();\n  } else {\n    console.log(\"Please provide a valid argument - deploy, delete or build\");\n  }\n};\n\nrun();\n","import path from \"path\";\nimport fs from \"fs\";\nimport { spawn } from \"child_process\";\n\nexport const filePath = () => {\n  const appPath = path.join(process.cwd(), \".\");\n  const srcOrApp = fs.existsSync(path.join(appPath, \"src\")) ? \"src/app\" : \"app\";\n  const srcPath = path.join(appPath, srcOrApp);\n  const scriptBasePath = path.join(__dirname, \"../../../\");\n  return {\n    srcPath: srcPath,\n    publicPath: path.join(appPath, \"public\"),\n    appPath: appPath,\n    standaloneOutputPath: path.join(appPath, \".next\", \"standalone\"),\n    staticOutputPath: path.join(appPath, \".next\", \"static\"),\n    tfPath: path.join(scriptBasePath, \"tf\"),\n  };\n};\n\nexport const term = (command: string): Promise<number> => {\n  return new Promise((resolve, reject) => {\n    const child = spawn(command, { shell: true });\n\n    child.stdout.on(\"data\", (data) => {\n      process.stdout.write(`${data}`);\n    });\n\n    child.stderr.on(\"data\", (data) => {\n      console.error(`${data}`);\n    });\n\n    child.on(\"close\", (code) => {\n      resolve(code!);\n    });\n\n    child.on(\"error\", (error) => {\n      console.error(`Error: ${error}`);\n      reject(error);\n    });\n  });\n};\n","module.exports = require(\"child_process\");","module.exports = require(\"fs\");","module.exports = require(\"path\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(\"./src/index.ts\");\n",""],"names":[],"sourceRoot":""}