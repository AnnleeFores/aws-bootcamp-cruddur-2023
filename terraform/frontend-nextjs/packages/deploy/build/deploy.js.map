{"version":3,"file":"deploy.js","mappings":"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","sources":["webpack://nextjs13-lambda/./src/build.ts","webpack://nextjs13-lambda/./src/deploy.ts","webpack://nextjs13-lambda/./src/index.ts","webpack://nextjs13-lambda/./src/utils.ts","webpack://nextjs13-lambda/external node-commonjs \"child_process\"","webpack://nextjs13-lambda/external node-commonjs \"fs\"","webpack://nextjs13-lambda/external node-commonjs \"path\"","webpack://nextjs13-lambda/webpack/bootstrap","webpack://nextjs13-lambda/webpack/startup"],"sourcesContent":["import path from \"path\";\nimport fs from \"fs\";\nimport { filePath } from \"./utils\";\nimport { term } from \"./utils\";\n\nconst nextjsBuild = async () => {\n  console.log(\"Running Next Build......\");\n  await term(\"npm run build\");\n};\n\nconst nextPackage = () => {\n  console.log(\"Copying static files.....\");\n  const { srcPath, publicPath, standaloneOutputPath } = filePath();\n\n  const destPublic = path.join(standaloneOutputPath, \"public\");\n\n  // Copy public files to standalone\n  if (fs.existsSync(publicPath)) {\n    if (!fs.existsSync(destPublic)) {\n      fs.mkdirSync(destPublic, { recursive: true });\n    }\n    fs.cpSync(publicPath, destPublic, { recursive: true });\n\n    // Copy favicon\n    const faviconPath = path.join(srcPath, \"favicon.ico\");\n\n    if (fs.existsSync(faviconPath)) {\n      fs.copyFileSync(faviconPath, path.join(destPublic, \"favicon.ico\"));\n    }\n  }\n};\n\nconst CreateRunScript = () => {\n  console.log(\"Creating run script.....\");\n\n  const { standaloneOutputPath } = filePath();\n\n  // run bash script code\n  const script = `#!/bin/bash\n[ ! -d '/tmp/cache' ] && mkdir -p /tmp/cache\nexec node server.js`;\n\n  fs.writeFile(`${standaloneOutputPath}/run.sh`, script, (err) => {\n    if (err) throw err;\n  });\n};\n\nexport const build = async () => {\n  await nextjsBuild();\n  nextPackage();\n  CreateRunScript();\n  console.log(\"Build complete!\");\n};\n","import { filePath, term } from \"./utils\";\n\nconst { tfPath, appPath } = filePath();\n\nexport const tfDeploy = async () => {\n  console.log(\"Running deploy command.....\");\n  await term(\n    `terraform -chdir=${tfPath}/ apply -var=\"SOURCE_DIR=${appPath}/.next\" --auto-approve`\n  );\n  console.log(\"\\nDeploy complete!\");\n  console.log(\n    \"\\nWait for CloudFront Deployment/Invalidation to complete....\\n\"\n  );\n};\n\nexport const tfDelete = async () => {\n  const { tfPath } = filePath();\n  console.log(\"Running deployment delete command.....\");\n  await term(\n    `terraform -chdir=${tfPath}/ destroy -var=\"SOURCE_DIR=${appPath}/.next\" --auto-approve`\n  );\n  console.log(\"Delete complete!\");\n};\n","import { build } from \"./build\";\nimport { tfDelete, tfDeploy } from \"./deploy\";\n\nconst deploy = async () => {\n  await build();\n  await tfDeploy();\n};\n\nconst del = async () => {\n  await tfDelete();\n};\n\n//Todo: Configure Deploy, Build, Delete conditionals\n\nconst run = () => {\n  const args = process.argv.slice(2);\n  if (args[0] === \"deploy\") {\n    deploy();\n  } else if (args[0] === \"build\") {\n    build();\n  } else if (args[0] === \"delete\") {\n    del();\n  } else {\n    console.log(\"Please provide a valid argument - deploy, delete or build\");\n  }\n};\n\nrun();\n","import path from \"path\";\nimport fs from \"fs\";\nimport { spawn } from \"child_process\";\n\nexport const filePath = () => {\n  const appPath = path.join(process.cwd(), \".\");\n  const srcOrApp = fs.existsSync(path.join(appPath, \"src\")) ? \"src/app\" : \"app\";\n  const srcPath = path.join(appPath, srcOrApp);\n  const basePath = path.join(process.cwd(), \"../\");\n  return {\n    srcPath: srcPath,\n    publicPath: path.join(appPath, \"public\"),\n    appPath: appPath,\n    standaloneOutputPath: path.join(appPath, \".next\", \"standalone\"),\n    staticOutputPath: path.join(appPath, \".next\", \"static\"),\n    tfPath: path.join(basePath, \"tf\"),\n  };\n};\n\nexport const term = (command: string): Promise<number> => {\n  return new Promise((resolve, reject) => {\n    const child = spawn(command, { shell: true });\n\n    child.stdout.on(\"data\", (data) => {\n      process.stdout.write(`${data}`);\n    });\n\n    child.stderr.on(\"data\", (data) => {\n      console.error(`${data}`);\n    });\n\n    child.on(\"close\", (code) => {\n      resolve(code!);\n    });\n\n    child.on(\"error\", (error) => {\n      console.error(`Error: ${error}`);\n      reject(error);\n    });\n  });\n};\n","module.exports = require(\"child_process\");","module.exports = require(\"fs\");","module.exports = require(\"path\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(607);\n"],"names":["build","console","log","term","srcPath","publicPath","standaloneOutputPath","filePath","destPublic","join","existsSync","mkdirSync","recursive","cpSync","faviconPath","copyFileSync","nextPackage","writeFile","err","CreateRunScript","tfPath","appPath","tfDeploy","tfDelete","args","process","argv","slice","run","cwd","srcOrApp","basePath","staticOutputPath","command","Promise","resolve","reject","child","spawn","shell","stdout","on","data","write","stderr","error","code","module","exports","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","call"],"sourceRoot":""}