#! /usr/bin/bash

set -e # stop execution if anything fails

ABS_FILEPATH="$ABS_PATH/aws/cfn/ddb"
LAMBDA_FILEPATH="$ABS_PATH/aws/lambdas/cruddur-messaging-stream/"
ARTIFACT_BUCKET="cfn-artifacts-annlee"

sam build \
    --config-file $ABS_FILEPATH/config.toml \
    --template-file $ABS_FILEPATH/template.yaml \
    --base-dir $LAMBDA_FILEPATH 
# --parameter-overrides

sam package \
    --s3-bucket $ARTIFACT_BUCKET \
    --config-file $ABS_FILEPATH/config.toml \
    --output-template-file $ABS_PATH/.aws-sam/build/package.yaml
    --s3-prefix "ddb"
    --template-file $ABS_PATH/.aws-sam/build/template.yaml"

sam deploy \
    --template-file $ABS_PATH/.aws-sam/build/package.yaml \
    --config-file $ABS_FILEPATH/config.toml \
    --stack-name "CrdDdb" \
    --tags group=cruddur-ddb \
    --capabilities "CAPABILITY_IAM"
