#!/bin/bash

set -e # stop execution if anything fails

ARTIFACTS_DIR="function"


ABS_FILEPATH="$ABS_PATH/frontend-nextjs/"
DIR=$(realpath --relative-base="$PWD" "$ABS_FILEPATH")


cd $DIR

# Functions

install() {
  npm ci
}

build() {
  npm run build
}

sync_static() {

    # sync static files to S3 + Cloudfront
    aws s3 cp .next/static/ s3://cdn.annleefores.cloud/_next/static/ --recursive
}

artifacts() {
  # Copy artifacts for deployment
  cp -r public/. .next/standalone/public

  cp -r .next/standalone/. $ARTIFACTS_DIR

  cp run.sh $ARTIFACTS_DIR
}


# Run functions if called directly

if [ "\$0" = "${BASH_SOURCE[0]}" ]; then
  install
  build
  sync_static
  artifacts
fi
